#US Primaries 2016: State Map Tutorial

In this tutorial we explain how to create your own US election map, how to replace the seed data with real data and how to tweak styles and colors.
<a href="http://www.datamap.io">Datamap</a> offers complete bundles containing everything you need to visualize the election results.
We use the <a href="https://elections.datamap.io/us/2016/primaries/states/iowa/republicans">2016 Republican Iowa Caucus Bundle</a> as our example.

<iframe
  style="border: 0px;"
  src="https://elections.datamap.io/us/2016/primaries/states/iowa/republicans/iframe"
  scrolling="no"
  width="960px"
  height="500px">
</iframe>

##Embed the map on your own site
Let's start with the easiest step, embedding <a href="https://elections.datamap.io/us/2016/primaries/states/iowa/republicans">this map</a> in your existing webpage. Add "iframe" at the end of the URL <a href="https://elections.datamap.io/us/2016/primaries/states/iowa/republicans/iframe">like so</a>: this is the link to the iframe version.  

To embed the above map, use this code on your own site:

```
<iframe
  style="border: 0px;"
  src="https://elections.datamap.io/us/2016/primaries/states/iowa/republicans/iframe"
  scrolling="no"
  width="960px"
  height="1178px">
</iframe>
```

You can try the code above to test on your own site. If that works for you, let us know on Twitter. We are <a href="https://twitter.com/datamapio">@datamapio</a>.
If your width is less than 960px as in our example, you can always adjust the variables width and height (the width is 500 px for the state map alone) in the index.html file . We will talk about the index.html file which is part of the zip in more detail later.


##Download and unzip
Now that you know how to embed the Iowa datamap from elsewhere, you can also download the same map and open it locally. 

Go to <a href="https://elections.datamap.io/us/2016/primaries/states/iowa/republicans#what_you_get">this page</a> and choose your price which ranges from free or $0 to $50. Then download the rep_primary_iowa_2016.zip and unzip it. 

The folder structure after unzipping looks like this:

```
rep_primary_iowa_2016/   
    - index.html   
    - README.txt       
    resources/     
        css/   
           - datamap.css           
        data/    
           - candidates_rep_2016.json   
           - EMPTY_rep_primary_iowa_county_2016.csv   
           - SEED_rep_primary_iowa_county_2016.csv
           - us_city_2010_2016.csv           
        img/   
           -... several photos of candidates           
        js/   
           -... several javascript files like d3, topoJSON etc.           
        map/   
           - iowa_county_20100326.json    
```

##Open the visualization with a local or remote server
To open the data visualization locally, click on the index.html file.

Most browsers prevent you from running the visualization in the file, when you do not have a local or 
remote server involved. 

So you have 3 choices:         
1. Firefox (works out of the box)      
2. Run your local server for all other browsers or      
3. Upload the unzipped bundle to a remote server.       
   
So if you have Chrome or Safari, you need to fire up a local web server first. 
We recommend <a href="https://www.npmjs.com/package/http-server">http-server</a>, but any local server will do.
A web server is needed to skirt security restrictions loading data out of the 
local file system. On the command line, run:     

http-server -p 8008 &    

If you visit <a href="http://localhost:8008">http://localhost:8008</a>, you should now see the data visualization.


So now that you have the data visualization up and running on your server, let us explain the important parts:    
- the map,    
- the data and     
- the visualization.   


##The map
The map comes as a topoJSON file with a date like in iowa_county_20100326.json. Now let’s explain what it contains and how you can make sense of it. 

iowa: First it tells you about the location, here Iowa.
Second it tells you about the area unit. Area units are divisions of a territory, they can be states, counties, ZIP codes, precincts, neighborhoods etc. In our example the area unit is county. And Iowa has 99 counties.

Last but not least comes the date of the source file in the format year, month, day. As county borders change, you might want to check if your data fits with your map. We also indicate the source in the bundle description, here it comes from the US Census and is from 2010 (counties haven't changed in Iowa).

Now to the format: what is TopoJSON? You might maybe be familiar with ESRI Shapefiles or GeoJSON. But TopoJSON? 

In the words of Mike Bostock (also the father of D3): 

TopoJSON is an extension of GeoJSON that encodes topology. Rather than representing geometries discretely, geometries in TopoJSON files are stitched together from shared line segments called arcs.
[...] As a result, TopoJSON is substantially more compact than GeoJSON. 
See: https://github.com/mbostock/topojson/wiki

And this is exactly the reason why we use TopoJSON. The smaller the map file is, the better is is for everyone. Alternatively Datamap will also offer GeoJSON (which you can use with services like Mapbox and CartoDB).


##The data
If you want to change something, e.g. replace fake SEED data with REAL caucus data, then this is done in the data folder.

The data folder contains the candidates_rep_2016.json with information about the candidates: first and last name, occupation, party, status and bgcolor which stands for the background color. This color is the one you are seeing on the map and which is associated with the candidate. We used the <a href="http://colorbrewer2.org/">Color Brewer qualitative colors</a> for our candidates, but feel free to change them.

The data folder also contains the SEED_rep_primary_iowa_county_2016.csv and the EMPTY_rep_primary_iowa_county_2016.csv.
The EMPTY file does not contain the number of votes per candidate in any given county, whereas the SEED data file contains made up numbers.
Once you have the real numbers, you can start plugging them into the EMPTY file and rename it SEED and your data visualization is automatically updated.

Both files have exactly the same structure, one county per row and columns for the county (id, name) and all relevant candidates.

| id     | county_name  | trump | rubio | bush | randpaul | ... other candidates | repnopref | repother |
|--------|--------------|-------|-------|------|----------|----------------------|-----------|----------|
|84019001| Adair County |  NA   |   NA  |  NA  |    NA    |        NA            |    NA     |    NA    |

The id references the shape of a county in the map (iowa_counties_and_cities_20100326.json); it is followed by the county name. Then we have all candidates. 
The names used here are candidate ids. If there are unexpectedly more candidates, you could simply add another column (and complete the information in the candidates_rep_2016.json.
The last two columns "repnopref" and "repother" simply stand for "No Preference" and "Other". 

Last but not least, we also have a us_city_2010_2016.csv: it adds the larger cities to our state map. We simply add the cities as points, that is why we don't need an other TopoJSON file for the city areas.   




##The visualization
The data visualization takes place inside the index.html file. It is here, that we map our data to visual variables.

We use the <a href="http://d3js.org/">D3</a> for our visualization. D3 stands for Data Driven Documents and is a JavaScript library for visualizing data with HTML, SVG, and CSS. D3 gives you the utmost flexibility for any data visualization.

Loading Files
Open the index.html to see what is happening. To understand how we load the map and the data, look at queue() (=> see <a href="https://github.com/d3/d3-queue">d3-queue</a>):

```
queue()
      .defer(d3.json, 'resources/map/iowa_county_20100326.json')              //county map of Iowa  
      .defer(d3.csv,  'resources/data/SEED_rep_primary_iowa_county_2016.csv') //number of votes per candidate  
      .defer(d3.csv,  'resources/data/us_city_2010_2016.csv')                 //some major cities in Iowa  
      .defer(d3.json, 'resources/data/candidates_rep_2016.json')              //candidate names etc. 
      .await(ready);
```

As you see the dates of the map and the data are not the same, the map being from August 2010, the election data is from now. This is often the case, but you should always check if your map is not outdated. Be aware that territories and therefore area units change all the time.

When you match your data to the map, we would  expect normally to have the same number of area units in both, but sometimes you also miss data for some counties. So prepare for this ahead in your visualization.    

##Data Changes and others
If you have some real data for the Iowa Caucus, you can update the EMPTY_rep_primary_iowa_county_2016.csv with the real numbers progressively.
You can rename the file SEED_rep_primary_iowa_county_2016.csv and it should work instantly. (Alternatively you can rename it REAL_rep_primary_iowa_county_2016.csv and change the file name in the queue().    

Besides the data, almost anything can be changed in this visualization. From CSS changes to candidate color changes, from size changes via the vars width and height, to different photos and fonts, you can really do what you want.    

          
(c) datamap.io, 2016     



